# Track-Me Chatbot API Usage Guide

## Tổng quan
Track-Me Chatbot API là một dịch vụ chatbot sử dụng Google Gemini AI để xử lý hội thoại, bảo mật bằng middleware và trả về phản hồi AI cho người dùng. API này không truy cập trực tiếp vào database ứng dụng TrackMe mà chỉ xử lý ngôn ngữ và ý định dựa trên dữ liệu đầu vào từ client.

---

## Luồng xử lý API

### 1. Controller (Router)
- Định tuyến chính: `/api/chat` (POST)
- Nhận dữ liệu từ client qua model `ChatRequest`
- Gọi service Gemini để sinh phản hồi AI
- Trả về kết quả qua model `ChatResponse`

### 2. Middleware
- `AuthMiddleware` kiểm tra nguồn gốc request (Origin, Referer) hoặc token bảo mật
- Chỉ cho phép các request hợp lệ truy cập API
- Ghi log chi tiết cho mỗi request

### 3. Service
- `GeminiService` xử lý tương tác với Google Gemini API
- Sinh phản hồi dựa trên prompt từ người dùng
- Có thể kiểm tra sức khỏe kết nối Gemini qua `/api/health`

---

## Dữ liệu đầu vào

### Model: `ChatRequest`
```json
{
  "message": "Đề xuất cho tôi các bài tập sức mạnh phù hợp với người mới bắt đầu",
  "user_id": "abc123", // (tùy chọn)
  "conversation_id": "xyz789" // (tùy chọn)
}
```
- `message`: Nội dung hội thoại hoặc yêu cầu của người dùng
- `user_id`: ID người dùng (nếu có, dùng để cá nhân hóa)
- `conversation_id`: ID hội thoại (nếu có, dùng để lưu lịch sử)

---

## Dữ liệu đầu ra

### Model: `ChatResponse`
```json
{
  "reply": "Dưới đây là các bài tập sức mạnh phù hợp cho người mới bắt đầu: ...",
  "conversation_id": "xyz789",
  "timestamp": "2025-07-11T10:00:00"
}
```
- `reply`: Phản hồi từ AI Gemini
- `conversation_id`: ID hội thoại (giúp client quản lý lịch sử chat)
- `timestamp`: Thời điểm trả về kết quả

### Model: `ErrorResponse` (nếu có lỗi)
```json
{
  "error": "Internal Server Error",
  "message": "An unexpected error occurred.",
  "timestamp": "2025-07-11T10:00:00"
}
```

---

## Quy trình xử lý chi tiết

1. **Client gửi request POST đến `/api/chat`**
   - Payload: `ChatRequest`
2. **Middleware kiểm tra nguồn gốc và token**
   - Nếu hợp lệ, chuyển tiếp request
   - Nếu không hợp lệ, trả về lỗi 403
3. **Controller nhận request, tạo/conversation_id nếu chưa có**
4. **Gọi GeminiService để sinh phản hồi AI**
   - Truyền prompt từ người dùng
   - Nhận lại reply từ Gemini
5. **Trả về kết quả cho client qua model `ChatResponse`**
6. **Ghi log toàn bộ quá trình xử lý**

---

## Ví dụ sử dụng API

### Request
```http
POST /api/chat
Content-Type: application/json
x-auth-token: <SECRET_TOKEN>

{
  "message": "Tôi muốn các bài tập cardio cho người trung cấp",
  "user_id": "user_001"
}
```

### Response
```json
{
  "reply": "Các bài tập cardio phù hợp cho người trung cấp gồm: ...",
  "conversation_id": "<auto-generated-uuid>",
  "timestamp": "2025-07-11T10:00:00"
}
```

---

## Endpoint Health Check

### Request
```http
GET /api/health
```

### Response
```json
{
  "status": "healthy",
  "gemini_api": "connected",
  "timestamp": "2025-07-11T10:00:00"
}
```

---

## Lưu ý bảo mật
- Chỉ các request có Origin/Referer hợp lệ hoặc token bảo mật mới được xử lý
- Log chi tiết mọi request và lỗi
- Không lưu trữ dữ liệu nhạy cảm trên chatbot server

---

## Tổng kết
- API này dùng để xử lý hội thoại AI, không truy vấn database TrackMe
- Dữ liệu đầu vào là prompt và thông tin người dùng (nếu có)
- Dữ liệu đầu ra là phản hồi AI hoặc thông báo lỗi
- Middleware đảm bảo bảo mật và kiểm soát truy cập

---

*Đây là tài liệu mô tả chi tiết quá trình sử dụng Track-Me Chatbot API từ controller đến khi trả về kết quả cho client.*
